!function(e){"use strict";e.module("alt.koopon.mensagens-contador-empresa",["ngResource","alt.passaporte-usuario-logado","alt.modal-service","alt.carregando-info","alt.koopon.notificacoes"]).provider("ALT_KOOPON_URL_BASE_API_MENSAGEM",[function(){this.urlBase="/koopon-rest-api/",this.$get=function(){return this.urlBase}}]).constant("ID_MODAL_MENSAGEM","#modal-nova-mensagem").constant("EVENTO_NOVO_ASSUNTO","mensagem:novo-assunto").constant("CHAVE_CLIENTE_ESCOLHIDO","cliente_escolhido").factory("AltKooponMensagemResource",["$resource","ALT_KOOPON_URL_BASE_API_MENSAGEM",function(e,n){var t=n+"mensagens/:id/:clientes/:idEmpresa",o={id:"@id"},s={assuntoLido:{method:"PUT",isArray:!1},enviar:{method:"POST",isArray:!1},enviarParaEmpresa:{method:"POST",isArray:!1,params:{clientes:"clientes"}},listarAssuntos:{method:"GET",isArray:!0},listarEmpresasAssuntos:{method:"GET",isArray:!1},listarMensagens:{method:"GET",isArray:!0},listarMensagensParaEmpresa:{method:"GET",isArray:!0,params:{clientes:"clientes"}},listarMensagensDaEmpresa:{method:"GET",isArray:!1}};return e(t,o,s)}]).factory("AltKooponMensagemModel",["AltPassaporteUsuarioLogadoManager",function(n){var t=function(n){this.assunto=void 0,this.texto=void 0,this.nomeUsuarioPassaporte=void 0,this.data=void 0,this.anexo=void 0,e.extend(this,n)};return t.prototype.isValid=function(){var n=e.isDefined(this.assunto)&&!!this.assunto.length,t=e.isDefined(this.texto)&&!!this.texto.length;return n&&t},t.prototype.msgDoUsuarioLogado=function(){return this.nomeUsuarioPassaporte===n.retorna().nomeUsuario},t.respostaValida=function(n){return e.isDefined(n)&&e.isDefined(n.texto)&&!!n.texto.length},t}]).factory("AltKooponMensagemService",["$q","AltKooponNotificacoesManager","AltKooponMensagemResource","AltKooponMensagemModel",function(n,t,o,s){var a=function(){};return a.prototype.listarAssuntos=function(){return o.listarAssuntos().$promise.then(function(e){return e.map(function(e){return new s(e)})})},a.prototype.listarEmpresasAssuntos=function(t){return e.isArray(t)?o.listarEmpresasAssuntos().$promise.then(function(e){var n=[];for(var o in e)t.forEach(function(t){t.idAssinante==o&&n.push({id:o,nome:t.nome,assuntos:e[o]})});return n}):n.reject(new TypeError("Empresas deve ser um array."))},a.prototype.listarMensagens=function(n,t){var a="listarMensagens",r={id:n};return e.isDefined(t)&&(a="listarMensagensParaEmpresa",r={id:n,idEmpresa:t}),o[a](r).$promise.then(function(e){return e.map(function(e){return new s(e)})})},a.prototype.listarMensagensDaEmpresa=function(t,s){if(!e.isArray(s))return n.reject(new TypeError("Empresas deve ser um array."));var a="listarMensagensDaEmpresa",r={idEmpresa:t};return o[a](r).$promise.then(function(e){var n=[];for(var t in e)s.forEach(function(o){o.idAssinante==t&&n.push({id:t,nome:o.nome,assuntos:e[t]})});return n})},a.prototype.enviar=function(n,a,r){var i="enviar",u={id:a};return e.isDefined(r)&&(i="enviarParaEmpresa",u={id:a,idEmpresa:r}),o[i](u,n).$promise.then(function(e){var n=t.retorna(),o=n.qtd?++n.qtd:1,a=n.qtdUltimaReq?++n.qtdUltimaReq:1;return t.atualiza("limpa",!0),t.atualiza("qtd",o),t.atualiza("qtdUltimaReq",a),new s(e)})},a.prototype.assuntoLido=function(e){return o.assuntoLido({id:e}).$promise},new a}]).controller("AltKooponNovaMensagemController",["$scope","$xtorage","AltKooponMensagemModel","AltKooponMensagemService","AltModalService","ID_MODAL_MENSAGEM","EVENTO_NOVO_ASSUNTO","CHAVE_CLIENTE_ESCOLHIDO",function(n,t,o,s,a,r,i,u){var c=this;t.getFromLocalStorage(u);c.empresas=[],c.mensagem=new o,c.zeraInformacoes=function(e){c.mensagem=new o,e.$setPristine()},c.enviar=function(t,u,m){s.enviar(t,void 0,m).then(function(s){e.extend(s,t),c.mensagem=new o,u.$setPristine(),n.$emit(i,s),a.close(r)})},c.init=function(e,n){c.empresas=e||[],c.mensagem.empresaEscolhida=n||null}}]).directive("altKooponEnterSubmit",[function(){return function(e,n,t){n.find(t.seletor).on("keydown",function(e){if(e.ctrlKey&&13===e.which){var o=n.find(t.btnSubmit).eq(0);o.attr("disabled")||o.click()}})}}]).directive("altKooponMensagemToggle",[function(){return function(n,t,o){var s=void 0,a=void 0;t.find(".assunto-mensagem").on("click",function(){return s=e.element(".mensagens-container"),a=t.find(".mensagens-container"),a.is(":visible")?void a.slideUp("fast"):(s.slideUp("fast"),void a.slideDown("fast"))})}}]).directive("altKooponMensagemActive",[function(){return function(e,n,t){n.on("click",function(){return n.hasClass("active")?void n.removeClass("active"):void(n.next(".mensagens-container").eq(0).is(":visible")||($("[alt-koopon-mensagem-active]").removeClass("active"),n.addClass("active")))})}}])}(window.angular);