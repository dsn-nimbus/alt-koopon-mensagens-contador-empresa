!function(){"use strict";angular.module("alt.koopon.mensagens-contador-empresa",["ngResource","alt.passaporte-usuario-logado","alt.modal-service","alt.carregando-info","alt.koopon.notificacoes"]).provider("ALT_KOOPON_URL_BASE_API_MENSAGEM",[function(){this.urlBase="/koopon-rest-api/",this.$get=function(){return this.urlBase}}]).constant("ID_MODAL_MENSAGEM","#modal-nova-mensagem").constant("EVENTO_NOVO_ASSUNTO","mensagem:novo-assunto").constant("CHAVE_CLIENTE_ESCOLHIDO","cliente_escolhido").factory("AltKooponMensagemResource",["$resource","ALT_KOOPON_URL_BASE_API_MENSAGEM",function(n,e){var o=e+"mensagens/:id/:clientes/:idEmpresa",t={id:"@id"},s={assuntoLido:{method:"PUT",isArray:!1},enviar:{method:"POST",isArray:!1},enviarParaEmpresa:{method:"POST",isArray:!1,params:{clientes:"clientes"}},listarAssuntos:{method:"GET",isArray:!0},listarEmpresasAssuntos:{method:"GET",isArray:!1},listarMensagens:{method:"GET",isArray:!0},listarMensagensParaEmpresa:{method:"GET",isArray:!0,params:{clientes:"clientes"}},listarMensagensDaEmpresa:{method:"GET",isArray:!1}};return n(o,t,s)}]).factory("AltKooponMensagemModel",["AltPassaporteUsuarioLogadoManager",function(n){var e=function(n){this.assunto=void 0,this.texto=void 0,this.nomeUsuarioPassaporte=void 0,this.data=void 0,this.anexo=void 0,angular.extend(this,n)};return e.prototype.isValid=function(){var n=angular.isDefined(this.assunto)&&!!this.assunto.length,e=angular.isDefined(this.texto)&&!!this.texto.length;return n&&e},e.prototype.msgDoUsuarioLogado=function(){return this.nomeUsuarioPassaporte===n.retorna().nomeUsuario},e.respostaValida=function(n){return angular.isDefined(n)&&angular.isDefined(n.texto)&&!!n.texto.length},e}]).factory("AltKooponMensagemService",["$q","AltPassaporteUsuarioLogadoManager","AltKooponNotificacoesManager","AltKooponMensagemResource","AltKooponMensagemModel",function(n,e,o,t,s){var a=function(){};return a.prototype.listarAssuntos=function(){return t.listarAssuntos().$promise.then(function(n){return n.map(function(n){return new s(n)})})["catch"](function(e){return n.reject(e)})},a.prototype.listarEmpresasAssuntos=function(){return t.listarEmpresasAssuntos().$promise.then(function(n){var o=[],t=e.retorna().assinantesEmpresa;for(var s in n)t.forEach(function(e){e.id==s&&o.push({id:s,nome:e.nome,assuntos:n[s]})});return o})["catch"](function(e){return n.reject(e)})},a.prototype.listarMensagens=function(e,o){var a="listarMensagens",r={id:e};return angular.isDefined(o)&&(a="listarMensagensParaEmpresa",r={id:e,idEmpresa:o}),t[a](r).$promise.then(function(n){return n.map(function(n){return new s(n)})})["catch"](function(e){return n.reject(e)})},a.prototype.listarMensagensDaEmpresa=function(o){var s="listarMensagensDaEmpresa",a={idEmpresa:o};return t[s](a).$promise.then(function(n){var o=[],t=e.retorna().assinantesEmpresa;for(var s in n)t.forEach(function(e){e.id==s&&o.push({id:s,nome:e.nome,assuntos:n[s]})});return o})["catch"](function(e){return n.reject(e)})},a.prototype.enviar=function(e,a,r){var i="enviar",u={id:a};return angular.isDefined(r)&&(i="enviarParaEmpresa",u={id:a,idEmpresa:r}),t[i](u,e).$promise.then(function(n){var e=o.retorna(),t=e.qtd?++e.qtd:1,a=e.qtdUltimaReq?++e.qtdUltimaReq:1;return o.atualiza("limpa",!0),o.atualiza("qtd",t),o.atualiza("qtdUltimaReq",a),new s(n)})["catch"](function(e){return n.reject(e)})},a.prototype.assuntoLido=function(e){return t.assuntoLido({id:e}).$promise.then(function(){})["catch"](function(e){return n.reject(e)})},new a}]).controller("AltKooponMensagensController",["$scope","AltKooponMensagemModel","AltKooponMensagemService","AltCarregandoInfoService","EVENTO_NOVO_ASSUNTO",function(n,e,o,t,s){var a=this;a.novaMensagem=!1,a.AltKooponMensagemModel=e,a.mensagem=new e,a.assuntos=[],a.responder=function(n,e){o.enviar(n,e).then(function(n){a.assuntos.forEach(function(o){return o.idMensagem===e?(a.mensagem="",o.mensagens.push(n)):void 0})})},a.listarMensagens=function(n,e){return e.aberto?e.aberto=!1:(e.aberto=!0,void o.listarMensagens(n).then(function(e){return a.assuntos.forEach(function(o){return o.idMensagem===n?o.mensagens=e:void 0}),o.assuntoLido(n)}))},function(){t.exibe(),o.listarAssuntos().then(function(n){a.assuntos=n})["finally"](function(){t.esconde()}),n.$on(s,function(n,e){a.assuntos.push(e)})}()}]).controller("AltKooponEmpresasComMensagensController",["$scope","$xtorage","AltKooponMensagemModel","AltKooponMensagemService","AltCarregandoInfoService","EVENTO_NOVO_ASSUNTO","CHAVE_CLIENTE_ESCOLHIDO",function(n,e,o,t,s,a,r){var i=this;i.AltKooponMensagemModel=o,i.empresas=[],i.listarMensagens=function(n,e){t.listarMensagens(e,n).then(function(o){i.empresas.forEach(function(t){t.id===n&&t.assuntos.forEach(function(n){return n.idMensagem===e?n.mensagens=o:void 0})})})},i.responder=function(n,e,o){t.enviar(n,o,e).then(function(n){i.empresas.forEach(function(t){t.id===e&&t.assuntos.forEach(function(e){return e.idMensagem===o?(i.mensagem="",e.mensagens.push(n)):void 0})})})["catch"](function(){})},i._listarEmpresasAssuntos=function(){s.exibe(),t.listarEmpresasAssuntos().then(function(n){i.empresas=n})["catch"](function(n){})["finally"](function(){s.esconde()})},i._listarEmpresaSelecionadaAssuntos=function(n){s.exibe(),t.listarMensagensDaEmpresa(n.id).then(function(e){e.forEach(function(e){e.id==n.id&&(i.empresas=[e])})})["catch"](function(n){})["finally"](function(){s.esconde()})},function(){var o=e.getFromLocalStorage(r);if(null===o||void 0!==o.messageDisplayed)i._listarEmpresasAssuntos(),e.removeFromLocalStorage(r);else{i._listarEmpresaSelecionadaAssuntos(o),o.messageDisplayed=!0;var t=JSON.stringify(o);angular.isUndefined(t)||e.save(r,t)}n.$on(a,function(n,e){i.empresas.forEach(function(n){return n.id==e.empresaEscolhida?n.assuntos.push(e):void 0})})}()}]).controller("AltKooponNovaMensagemController",["$scope","$xtorage","AltKooponMensagemModel","AltKooponMensagemService","AltModalService","AltPassaporteUsuarioLogadoManager","ID_MODAL_MENSAGEM","EVENTO_NOVO_ASSUNTO","CHAVE_CLIENTE_ESCOLHIDO",function(n,e,o,t,s,a,r,i,u){var c=this;c.mensagem=new o;var l=e.getFromLocalStorage(u);c.clientes=a.retorna().assinantesEmpresa,c.mensagem.empresaEscolhida=l||null,c.zeraInformacoes=function(n){c.mensagem=new o,n.$setPristine()},c.enviar=function(e,a,u){t.enviar(e,void 0,u).then(function(t){angular.extend(t,e),c.mensagem=new o,a.$setPristine(),n.$emit(i,t),s.close(r)})["catch"](function(n){})}}]).directive("altKooponEnterSubmit",[function(){return function(n,e,o){e.find(o.seletor).on("keydown",function(n){if(n.ctrlKey&&13===n.which){var t=e.find(o.btnSubmit).eq(0);t.attr("disabled")||t.click()}})}}]).directive("altKooponMensagemToggle",[function(){return function(n,e,o){var t=void 0,s=void 0;e.find(".assunto-mensagem").on("click",function(){return t=angular.element(".mensagens-container"),s=e.find(".mensagens-container"),s.is(":visible")?void s.slideUp("fast"):(t.slideUp("fast"),void s.slideDown("fast"))})}}]).directive("altKooponMensagemActive",[function(){return function(n,e,o){e.on("click",function(){return e.hasClass("active")?void e.removeClass("active"):void(e.next(".mensagens-container").eq(0).is(":visible")||($("[alt-koopon-mensagem-active]").removeClass("active"),e.addClass("active")))})}}])}();