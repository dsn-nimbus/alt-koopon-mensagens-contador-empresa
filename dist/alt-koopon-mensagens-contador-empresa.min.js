!function(){"use strict";angular.module("alt.koopon.mensagens-contador-empresa",["ngResource","alt.passaporte-usuario-logado","alt.modal-service","alt.carregando-info","alt.koopon.notificacoes"]).provider("ALT_KOOPON_URL_BASE_API_MENSAGEM",[function(){this.urlBase="/koopon-rest-api/",this.$get=function(){return this.urlBase}}]).constant("ID_MODAL_MENSAGEM","#modal-nova-mensagem").constant("EVENTO_NOVO_ASSUNTO","mensagem:novo-assunto").factory("AltKooponMensagemResource",["$resource","ALT_KOOPON_URL_BASE_API_MENSAGEM",function(n,e){var o=e+"mensagens/:id/:clientes/:idEmpresa",t={id:"@id"},s={assuntoLido:{method:"PUT",isArray:!1},enviar:{method:"POST",isArray:!1},enviarParaEmpresa:{method:"POST",isArray:!1,params:{clientes:"clientes"}},listarAssuntos:{method:"GET",isArray:!0},listarEmpresasAssuntos:{method:"GET",isArray:!1},listarMensagens:{method:"GET",isArray:!0},listarMensagensParaEmpresa:{method:"GET",isArray:!0,params:{clientes:"clientes"}}};return n(o,t,s)}]).factory("AltKooponMensagemModel",["AltPassaporteUsuarioLogadoManager",function(n){var e=function(n){this.assunto=void 0,this.texto=void 0,this.nomeUsuarioPassaporte=void 0,this.data=void 0,this.anexo=void 0,angular.extend(this,n)};return e.prototype.isValid=function(){var n=angular.isDefined(this.assunto)&&!!this.assunto.length,e=angular.isDefined(this.texto)&&!!this.texto.length;return n&&e},e.prototype.msgDoUsuarioLogado=function(){return this.nomeUsuarioPassaporte===n.retorna().nomeUsuario},e.respostaValida=function(n){return angular.isDefined(n)&&angular.isDefined(n.texto)&&!!n.texto.length},e}]).factory("AltKooponMensagemService",["$q","AltPassaporteUsuarioLogadoManager","AltKooponNotificacoesManager","AltKooponMensagemResource","AltKooponMensagemModel",function(n,e,o,t,s){var a=function(){};return a.prototype.listarAssuntos=function(){return t.listarAssuntos().$promise.then(function(n){return n.map(function(n){return new s(n)})})["catch"](function(e){return n.reject(e)})},a.prototype.listarEmpresasAssuntos=function(){return t.listarEmpresasAssuntos().$promise.then(function(n){var o=[],t=e.retorna().assinantesEmpresa;for(var s in n)t.forEach(function(e){e.id==s&&o.push({id:s,nome:e.nome,assuntos:n[s]})});return o})["catch"](function(e){return n.reject(e)})},a.prototype.listarMensagens=function(e,o){var a="listarMensagens",r={id:e};return angular.isDefined(o)&&(a="listarMensagensParaEmpresa",r={id:e,idEmpresa:o}),t[a](r).$promise.then(function(n){return n.map(function(n){return new s(n)})})["catch"](function(e){return n.reject(e)})},a.prototype.enviar=function(e,a,r){var i="enviar",u={id:a};return angular.isDefined(r)&&(i="enviarParaEmpresa",u={id:a,idEmpresa:r}),t[i](u,e).$promise.then(function(n){var e=o.retorna(),t=e.qtd?++e.qtd:1,a=e.qtdUltimaReq?++e.qtdUltimaReq:1;return o.atualiza("limpa",!0),o.atualiza("qtd",t),o.atualiza("qtdUltimaReq",a),new s(n)})["catch"](function(e){return n.reject(e)})},a.prototype.assuntoLido=function(e){return t.assuntoLido({id:e}).$promise.then(function(){})["catch"](function(e){return n.reject(e)})},new a}]).controller("AltKooponMensagensController",["$scope","AltKooponMensagemModel","AltKooponMensagemService","AltCarregandoInfoService","EVENTO_NOVO_ASSUNTO",function(n,e,o,t,s){var a=this;a.novaMensagem=!1,a.AltKooponMensagemModel=e,a.mensagem=new e,a.assuntos=[],a.responder=function(n,e){o.enviar(n,e).then(function(n){a.assuntos.forEach(function(o){return o.idMensagem===e?(a.mensagem="",o.mensagens.push(n)):void 0})})},a.listarMensagens=function(n,e){return e.aberto?e.aberto=!1:(e.aberto=!0,void o.listarMensagens(n).then(function(e){return a.assuntos.forEach(function(o){return o.idMensagem===n?o.mensagens=e:void 0}),o.assuntoLido(n)}))},function(){t.exibe(),o.listarAssuntos().then(function(n){a.assuntos=n})["finally"](function(){t.esconde()}),n.$on(s,function(n,e){a.assuntos.push(e)})}()}]).controller("AltKooponEmpresasComMensagensController",["$scope","AltKooponMensagemModel","AltKooponMensagemService","AltCarregandoInfoService","EVENTO_NOVO_ASSUNTO",function(n,e,o,t,s){var a=this;a.AltKooponMensagemModel=e,a.empresas=[],a.listarMensagens=function(n,e){o.listarMensagens(e,n).then(function(o){a.empresas.forEach(function(t){t.id===n&&t.assuntos.forEach(function(n){return n.idMensagem===e?n.mensagens=o:void 0})})})},a.responder=function(n,e,t){o.enviar(n,t,e).then(function(n){a.empresas.forEach(function(o){o.id===e&&o.assuntos.forEach(function(e){return e.idMensagem===t?(a.mensagem="",e.mensagens.push(n)):void 0})})})["catch"](function(){})},function(){t.exibe(),o.listarEmpresasAssuntos().then(function(n){a.empresas=n})["catch"](function(n){})["finally"](function(){t.esconde()}),n.$on(s,function(n,e){a.empresas.forEach(function(n){return n.id==e.empresaEscolhida?n.assuntos.push(e):void 0})})}()}]).controller("AltKooponNovaMensagemController",["$scope","AltKooponMensagemModel","AltKooponMensagemService","AltModalService","AltPassaporteUsuarioLogadoManager","ID_MODAL_MENSAGEM","EVENTO_NOVO_ASSUNTO",function(n,e,o,t,s,a,r){var i=this;i.mensagem=new e,i.clientes=s.retorna().assinantesEmpresa,i.zeraInformacoes=function(n){i.mensagem=new e,n.$setPristine()},i.enviar=function(s,u,c){o.enviar(s,void 0,c).then(function(o){angular.extend(o,s),i.mensagem=new e,u.$setPristine(),n.$emit(r,o),t.close(a)})["catch"](function(n){})}}]).directive("altKooponEnterSubmit",[function(){return function(n,e,o){e.find(o.seletor).on("keydown",function(n){if(n.ctrlKey&&13===n.which){var t=e.find(o.btnSubmit).eq(0);t.attr("disabled")||t.click()}})}}]).directive("altKooponMensagemToggle",[function(){return function(n,e,o){var t=void 0,s=void 0;e.find(".assunto-mensagem").on("click",function(){return t=angular.element(".mensagens-container"),s=e.find(".mensagens-container"),s.is(":visible")?void s.slideUp("fast"):(t.slideUp("fast"),void s.slideDown("fast"))})}}]).directive("altKooponMensagemActive",[function(){return function(n,e,o){e.on("click",function(){return e.hasClass("active")?void e.removeClass("active"):void(e.next(".mensagens-container").eq(0).is(":visible")||($("[alt-koopon-mensagem-active]").removeClass("active"),e.addClass("active")))})}}])}();